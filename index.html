<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Device Verification</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', system-ui, sans-serif;
  }

  body, html {
    height: 100%;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    overflow: hidden;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .container {
    text-align: center;
    color: white;
    padding: 40px 30px;
    max-width: 500px;
    width: 90%;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    border-radius: 24px;
    box-shadow: 
      0 20px 40px rgba(0, 0, 0, 0.2),
      0 0 0 1px rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
    transition: all 0.5s ease;
  }

  .container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff);
    background-size: 400% 400%;
    animation: gradientShift 4s ease infinite;
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .logo {
    margin-bottom: 30px;
    display: flex;
    justify-content: center;
  }

  .logo-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .loading-text {
    font-size: 24px;
    margin-bottom: 40px;
    font-weight: 600;
    letter-spacing: 0.5px;
    position: relative;
    display: inline-block;
  }

  .loading-text::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 10%;
    width: 80%;
    height: 3px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
    border-radius: 3px;
  }

  /* Advanced Loader */
  .advanced-loader {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto 40px;
  }

  .orbital {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid transparent;
    animation: spin 3s linear infinite;
  }

  .orbital:nth-child(1) {
    border-top: 2px solid #ff6b6b;
    animation-delay: 0s;
  }

  .orbital:nth-child(2) {
    border-right: 2px solid #ffd93d;
    width: 80%;
    height: 80%;
    top: 10%;
    left: 10%;
    animation-delay: 0.1s;
    animation-duration: 2.5s;
    animation-direction: reverse;
  }

  .orbital:nth-child(3) {
    border-bottom: 2px solid #6bcf7f;
    width: 60%;
    height: 60%;
    top: 20%;
    left: 20%;
    animation-delay: 0.2s;
    animation-duration: 2s;
  }

  .center-dot {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .progress-text {
    font-size: 14px;
    margin-top: 20px;
    opacity: 0.8;
    letter-spacing: 1px;
  }

  .message {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 25px;
    line-height: 1.4;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .sub-message {
    font-size: 16px;
    margin-bottom: 30px;
    opacity: 0.9;
    max-width: 80%;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.5;
  }

  .btn {
    padding: 16px 40px;
    font-size: 18px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    color: white;
    background: linear-gradient(135deg, #6bcf7f, #4d96ff);
    transition: all 0.4s ease;
    margin: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
  }

  .btn:active {
    transform: translateY(-1px);
  }

  .btn-red {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
  }

  .btn-orange {
    background: linear-gradient(135deg, #ffa726, #ffb74d);
  }

  .result-icon {
    font-size: 80px;
    margin-bottom: 25px;
    display: block;
    animation: iconAppear 0.8s ease;
  }

  @keyframes iconAppear {
    0% { transform: scale(0); opacity: 0; }
    70% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }

  .hidden {
    display: none;
  }

  .floating-shapes {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -1;
    overflow: hidden;
  }

  .shape {
    position: absolute;
    opacity: 0.1;
    animation: float 20s infinite linear;
  }

  .shape:nth-child(1) {
    width: 80px;
    height: 80px;
    background: #ff6b6b;
    border-radius: 50%;
    top: 10%;
    left: 10%;
    animation-delay: 0s;
  }

  .shape:nth-child(2) {
    width: 100px;
    height: 100px;
    background: #4d96ff;
    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    top: 70%;
    left: 80%;
    animation-delay: -5s;
    animation-duration: 25s;
  }

  .shape:nth-child(3) {
    width: 120px;
    height: 120px;
    background: #ffd93d;
    border-radius: 50%;
    top: 20%;
    left: 80%;
    animation-delay: -10s;
    animation-duration: 30s;
  }

  .shape:nth-child(4) {
    width: 60px;
    height: 60px;
    background: #6bcf7f;
    border-radius: 50%;
    top: 80%;
    left: 20%;
    animation-delay: -15s;
  }

  @keyframes float {
    0% {
      transform: translate(0, 0) rotate(0deg);
    }
    25% {
      transform: translate(10px, 30px) rotate(90deg);
    }
    50% {
      transform: translate(20px, 0) rotate(180deg);
    }
    75% {
      transform: translate(10px, -30px) rotate(270deg);
    }
    100% {
      transform: translate(0, 0) rotate(360deg);
    }
  }

  .progress-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    margin: 30px auto;
    width: 80%;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff);
    background-size: 400% 400%;
    border-radius: 3px;
    animation: gradientShift 4s ease infinite, fillProgress 4s ease-in-out forwards;
  }

  @keyframes fillProgress {
    0% { width: 0%; }
    100% { width: 100%; }
  }

  .security-features {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .feature {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    opacity: 0.8;
  }

  .feature i {
    font-size: 16px;
  }

  @media (max-width: 480px) {
    .container {
      padding: 30px 20px;
    }
    
    .message {
      font-size: 24px;
    }
    
    .btn {
      padding: 14px 30px;
      font-size: 16px;
    }
    
    .security-features {
      gap: 10px;
    }
  }
</style>
</head>
<body>
<div class="floating-shapes">
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
</div>

<div class="container" id="main">
  <div class="logo">
    <div class="logo-circle">
      <i class="fas fa-fingerprint"></i>
    </div>
  </div>
  
  <div class="loading-text">Advanced Device Verification</div>
  
  <div class="advanced-loader">
    <div class="orbital"></div>
    <div class="orbital"></div>
    <div class="orbital"></div>
    <div class="center-dot"></div>
  </div>
  
  <div class="progress-text" id="progressText">Initializing security protocols...</div>
  
  <div class="progress-bar">
    <div class="progress-fill"></div>
  </div>
  
  <div class="security-features">
    <div class="feature"><i class="fas fa-microchip"></i> Hardware Analysis</div>
    <div class="feature"><i class="fas fa-network-wired"></i> Network Security</div>
    <div class="feature"><i class="fas fa-shield-alt"></i> Device Integrity</div>
  </div>
</div>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const webhookUrl = urlParams.get('webhookUrl');
const botId = urlParams.get('botId') || 'default';

// Advanced device fingerprinting with multiple techniques
function generateAdvancedFingerprint() {
  const components = [];
  
  // 1. Basic browser info
  components.push(navigator.userAgent);
  components.push(navigator.language);
  components.push(navigator.hardwareConcurrency || 'unknown');
  components.push(navigator.deviceMemory || 'unknown');
  
  // 2. Screen properties
  components.push(screen.width + 'x' + screen.height);
  components.push(screen.colorDepth);
  components.push(screen.pixelDepth);
  
  // 3. Timezone and locale
  components.push(new Date().getTimezoneOffset());
  components.push(Intl.DateTimeFormat().resolvedOptions().timeZone);
  
  // 4. WebGL renderer (hardware-based)
  const webglInfo = getWebGLInfo();
  components.push(webglInfo);
  
  // 5. Audio context fingerprint
  const audioFingerprint = getAudioFingerprint();
  components.push(audioFingerprint);
  
  // 6. Canvas fingerprint
  const canvasFingerprint = getCanvasFingerprint();
  components.push(canvasFingerprint);
  
  // 7. Installed fonts (limited)
  const fontFingerprint = getFontFingerprint();
  components.push(fontFingerprint);
  
  const combined = components.join('|');
  
  // Advanced hash function
  let hash = 0;
  for (let i = 0; i < combined.length; i++) {
    const char = combined.charCodeAt(i);
    hash = ((hash << 7) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36) + '-' + 
         components.length.toString(36) + '-' + 
         Date.now().toString(36).slice(-4);
}

// WebGL fingerprinting
function getWebGLInfo() {
  try {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    if (!gl) return 'no-webgl';
    
    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
    if (debugInfo) {
      return gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) || 'unknown-renderer';
    }
    return 'webgl-no-debug';
  } catch (e) {
    return 'webgl-error';
  }
}

// Audio context fingerprinting
function getAudioFingerprint() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const analyser = audioContext.createAnalyser();
    
    oscillator.connect(analyser);
    analyser.connect(audioContext.destination);
    
    oscillator.start();
    const data = new Float32Array(analyser.frequencyBinCount);
    analyser.getFloatFrequencyData(data);
    oscillator.stop();
    
    // Create a simple hash from the audio data
    let hash = 0;
    for (let i = 0; i < Math.min(10, data.length); i++) {
      hash = ((hash << 5) - hash) + Math.abs(Math.round(data[i]));
      hash = hash & hash;
    }
    
    audioContext.close();
    return Math.abs(hash).toString(36).slice(0, 6);
  } catch (e) {
    return 'audio-error';
  }
}

// Canvas fingerprinting
function getCanvasFingerprint() {
  try {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 200;
    canvas.height = 50;
    
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillStyle = '#f60';
    ctx.fillRect(125, 1, 62, 20);
    ctx.fillStyle = '#069';
    ctx.fillText('DeviceVerify', 2, 15);
    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
    ctx.fillText('DeviceVerify', 4, 17);
    
    return canvas.toDataURL().substring(22, 40); // Base64 part
  } catch (e) {
    return 'canvas-error';
  }
}

// Font detection (limited approach)
function getFontFingerprint() {
  const fonts = ['Arial', 'Times New Roman', 'Courier New', 'Verdana', 'Georgia'];
  const testString = "DeviceVerification";
  const testSize = "50px";
  
  const baseWidths = {};
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // First get the default font width
  ctx.font = testSize + ' monospace';
  baseWidths.monospace = ctx.measureText(testString).width;
  
  // Test each font
  let detectedFonts = [];
  for (const font of fonts) {
    ctx.font = testSize + ' ' + font;
    const width = ctx.measureText(testString).width;
    if (Math.abs(width - baseWidths.monospace) > 1) {
      detectedFonts.push(font.substring(0, 3));
    }
  }
  
  return detectedFonts.join(',') || 'default-fonts';
}

// Advanced VPN detection with multiple checks
async function detectVPN() {
  const checks = [];
  
  // Check 1: Automation detection
  checks.push(navigator.webdriver === true);
  checks.push(/HeadlessChrome|PhantomJS|Selenium/i.test(navigator.userAgent));
  checks.push(typeof window.phantom !== 'undefined');
  checks.push(typeof window.callPhantom !== 'undefined');
  
  // Check 2: Browser properties that might indicate automation
  checks.push(navigator.plugins.length === 0);
  checks.push(navigator.languages.length === 0);
  
  // Check 3: Screen size anomalies (common in headless browsers)
  checks.push(screen.width < 100 || screen.height < 100);
  checks.push(window.outerWidth === 0 || window.outerHeight === 0);
  
  // Only flag as VPN if we have multiple strong indicators
  const strongIndicators = checks.filter(Boolean).length;
  return strongIndicators >= 3;
}

// Enhanced same device detection with multiple storage methods
function checkSameDevice(advancedFingerprint, currentBotId) {
  // Method 1: LocalStorage (can be cleared)
  const localStorageKey = `adv_fingerprint_${currentBotId}`;
  const storedFingerprints = JSON.parse(localStorage.getItem(localStorageKey) || '[]');
  
  // Method 2: SessionStorage (survives page reloads)
  const sessionStorageKey = `session_fp_${currentBotId}`;
  const sessionFingerprints = JSON.parse(sessionStorage.getItem(sessionStorageKey) || '[]');
  
  // Method 3: IndexedDB for persistence
  checkIndexedDB(advancedFingerprint, currentBotId).then(isInIndexedDB => {
    if (isInIndexedDB && !storedFingerprints.includes(advancedFingerprint)) {
      storedFingerprints.push(advancedFingerprint);
      localStorage.setItem(localStorageKey, JSON.stringify(storedFingerprints));
    }
  });
  
  // Check if fingerprint exists in any storage
  const isInLocalStorage = storedFingerprints.includes(advancedFingerprint);
  const isInSessionStorage = sessionFingerprints.includes(advancedFingerprint);
  
  // If found in any storage, it's the same device
  if (isInLocalStorage || isInSessionStorage) {
    return true;
  }
  
  // Store the fingerprint for future checks
  storedFingerprints.push(advancedFingerprint);
  sessionFingerprints.push(advancedFingerprint);
  localStorage.setItem(localStorageKey, JSON.stringify(storedFingerprints));
  sessionStorage.setItem(sessionStorageKey, JSON.stringify(sessionFingerprints));
  
  return false;
}

// IndexedDB for more persistent storage
function checkIndexedDB(fingerprint, botId) {
  return new Promise((resolve) => {
    if (!window.indexedDB) {
      resolve(false);
      return;
    }
    
    const request = indexedDB.open('DeviceVerificationDB', 1);
    
    request.onerror = () => resolve(false);
    
    request.onsuccess = (event) => {
      const db = event.target.result;
      const transaction = db.transaction(['fingerprints'], 'readonly');
      const store = transaction.objectStore('fingerprints');
      const getRequest = store.get(`${botId}_${fingerprint}`);
      
      getRequest.onsuccess = () => {
        resolve(!!getRequest.result);
      };
      
      getRequest.onerror = () => resolve(false);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('fingerprints')) {
        db.createObjectStore('fingerprints');
      }
    };
  });
}

// Update progress during verification
function updateProgress(text) {
  const progressText = document.getElementById('progressText');
  if (progressText) {
    progressText.textContent = text;
  }
}

// Main verification process
async function performVerification() {
  updateProgress("Analyzing hardware configuration...");
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  updateProgress("Checking network integrity...");
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  updateProgress("Verifying device fingerprint...");
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  updateProgress("Finalizing security assessment...");
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  const advancedFingerprint = generateAdvancedFingerprint();
  const isVPN = await detectVPN();
  const isSameDevice = checkSameDevice(advancedFingerprint, botId);
  
  console.log('Advanced Fingerprint:', advancedFingerprint);
  console.log('VPN Detection:', isVPN);
  console.log('Same Device:', isSameDevice);
  
  return {
    user_hash: advancedFingerprint,
    captcha: "true",
    vpn: isVPN.toString(),
    is_same_device: isSameDevice,
    bot_id: botId
  };
}

// Start verification
setTimeout(async () => {
  try {
    const verificationData = await performVerification();
    showResult(verificationData);
  } catch (error) {
    console.error('Verification error:', error);
    showError();
  }
}, 500);

function showResult(data) {
  const main = document.getElementById("main");
  
  let message = document.createElement("div");
  message.className = "message";

  let subMessage = document.createElement("div");
  subMessage.className = "sub-message";

  let button = document.createElement("button");
  button.className = "btn";

  let icon = document.createElement("div");
  icon.className = "result-icon";

  // Prepare result data
  const resultData = {
    results: {
      user_hash: data.user_hash,
      captcha: "true",
      vpn: data.vpn
    }
  };

  if (data.vpn === "true") {
    document.body.style.background = "linear-gradient(135deg, #ff6b6b 0%, #c44569 100%)";
    icon.innerHTML = '<i class="fas fa-ban"></i>';
    message.textContent = "Security Alert";
    subMessage.textContent = "Unusual network activity detected. Please disable any VPN or proxy services.";
    button.textContent = "Exit";
    button.className = "btn btn-red";
    button.onclick = () => {
      resultData.results.captcha = "false";
      sendResult(resultData);
    };
  } else if (data.is_same_device) {
    document.body.style.background = "linear-gradient(135deg, #ffa726 0%, #ff8f00 100%)";
    icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
    message.textContent = "Device Already Registered";
    subMessage.textContent = "This device is already associated with another account. Each device can only be used with one account.";
    button.textContent = "Understand";
    button.className = "btn btn-orange";
    button.onclick = () => {
      sendResult(resultData);
    };
  } else {
    document.body.style.background = "linear-gradient(135deg, #6bcf7f 0%, #4caf50 100%)";
    icon.innerHTML = '<i class="fas fa-check-circle"></i>';
    message.textContent = "Verification Successful";
    subMessage.textContent = "Your device has been verified and registered successfully.";
    button.textContent = "Continue";
    button.onclick = () => {
      sendResult(resultData);
    };
  }

  main.innerHTML = "";
  main.appendChild(icon);
  main.appendChild(message);
  main.appendChild(subMessage);
  main.appendChild(button);
}

// Send result to bot
function sendResult(data) {
  if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.sendData(JSON.stringify(data));
    window.Telegram.WebApp.close();
  } else if (window.opener) {
    window.opener.postMessage(data, '*');
    window.close();
  } else if (webhookUrl) {
    fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(() => {
      if (window.opener) window.close();
    }).catch(() => {
      if (window.opener) window.close();
    });
  } else {
    if (window.opener) window.close();
  }
}

function showError() {
  const main = document.getElementById("main");
  document.body.style.background = "linear-gradient(135deg, #ff6b6b 0%, #c44569 100%)";
  
  main.innerHTML = `
    <div class="result-icon"><i class="fas fa-exclamation-triangle"></i></div>
    <div class="message">Verification Failed</div>
    <div class="sub-message">An error occurred during verification. Please try again.</div>
    <button class="btn btn-red" onclick="window.location.reload()">Try Again</button>
  `;
}

// Telegram Web Apps integration
if (window.Telegram && window.Telegram.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}
</script>
</body>
</html>